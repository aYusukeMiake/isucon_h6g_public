# ログの取り方

## この資料について

- ISUCONでパフォーマンスチューニングをするうえで、必要なログを取る方法に関する資料
- 使うものは一例で、同様のデータが取れれば、他のツールでも問題ない
  - 長期的な運用を想定している場合、New Relicなどの高機能なサービスを使う方が良い
  - 今回はログファイルをローカルでそのまま解析するためのツールを主に扱う
    - 開発環境において、短期的な修正と改善結果の確認のサイクルを回すことを意識している
- 言語はRuby、ミドルウェアはNginx、DBはMySQLを想定

## アクセス解析(alp)

### alpとは

- alpはアクセスログを解析して、リクエストの処理時間を集計するツール
  [alpのREADME](https://github.com/tkuchiki/alp/blob/main/README.ja.md)
- Nginxのアクセスログを解析することで、下記のような情報を取得できる

```shell
+-------+-----+-----+-----+-----+-----+--------+--------------------+-------+-------+---------+-------+-------+-------+-------+--------+-------------+-------------+--------------+-------------+
| COUNT | 1XX | 2XX | 3XX | 4XX | 5XX | METHOD |        URI         |  MIN  |  MAX  |   SUM   |  AVG  |  P90  |  P95  |  P99  | STDDEV |  MIN(BODY)  |  MAX(BODY)  |  SUM(BODY)   |  AVG(BODY)  |
+-------+-----+-----+-----+-----+-----+--------+--------------------+-------+-------+---------+-------+-------+-------+-------+--------+-------------+-------------+--------------+-------------+
| 135   | 0   | 124 | 0   | 11  | 0   | GET    | /                  | 1.404 | 9.981 | 405.984 | 3.007 | 4.654 | 6.302 | 9.279 | 1.747  | 4598.000    | 5986.000    | 661701.000   | 4901.489    |
| 113   | 0   | 0   | 113 | 0   | 0   | POST   | /login             | 0.001 | 7.512 | 192.040 | 1.699 | 4.497 | 5.702 | 7.101 | 1.959  | 0.000       | 0.000       | 0.000        | 0.000       |
| 60    | 0   | 60  | 0   | 0   | 0   | GET    | /favicon.ico       | 0.006 | 8.902 | 186.888 | 3.115 | 7.139 | 8.272 | 8.902 | 2.714  | 43.000      | 43.000      | 2580.000     | 43.000      |
```

[private-isu](https://github.com/catatsuy/private-isu/tree/master)(ピクシブ株式会社で2016年に行われた社内ISUCONのお題)で実際にログを解析した結果から抜粋

ログの見方を軽く説明すると、`/`へのGETリクエストが135回あり、そのうち124回が2XXのステータスコードで、11回が4XXのステータスコードであることが分かる。また、平均で処理を終えるのに、3秒かかることが分かる。また、`/login`にも平均で1.7秒かかることが分かる。

上記のように、リクエストのパスごとに処理時間を集計することで、どのリクエストを改善するべきかが分かる。

### 実際に使うISUCONでの使用した際の流れ

#### 導入から試しに解析するまでの手順

- [alpのREADME](https://github.com/tkuchiki/alp/blob/main/README.ja.md)にあるバイナリを使用する方法でインストール
  - インストール後に`alp --version`でバージョンが表示されればOK
- nginxの設定
  - アクセスログを出すようにする
  - access_logのフォーマットをltsv形式に変更しておくと、alpで解析しやすい
  - 具体的な設定例は下記の通り

    ```nginx
    # alpで解析するためにltsv形式で出力
    log_format ltsv "time:$time_local"
      "\thost:$remote_addr"
      "\tforwardedfor:$http_x_forwarded_for"
      "\treq:$request"
      "\tmethod:$request_method"
      "\turi:$request_uri"
      "\tstatus:$status"
      "\tsize:$body_bytes_sent"
      "\treferer:$http_referer"
      "\tua:$http_user_agent"
      "\treqtime:$request_time"
      "\truntime:$upstream_http_x_runtime"
      "\tapptime:$upstream_response_time"
      "\tcache:$upstream_http_x_cache"
      "\tvhost:$host";
    access_log  /var/log/nginx/access.log ltsv; # アクセスログの出力先と形式を指定
    ```

- nginxを再起動
  - `sudo systemctl restart nginx.service`
- アクセスログでデータを集計するためにベンチマークを実行
- アクセスログを解析
  `sudo alp ltsv -r --sort=sum --file /var/log/nginx/access.log`
- ファイルに保存する
  `sudo alp ltsv -r --sort=sum --file /var/log/nginx/access.log > "$HOME/log/alp/alp_log_$(date +'%Y%m%d%H%M').txt"`

#### 設定ファイルを用いて解析する

このままだと、解析する際に、下記のようなパスにパラメータを含むリクエストで困る。例えば、`/image/[ファイル名]`というパスは同一のリクエストとして扱いたいが、下記のようにパスが異なるものとして扱われてしまうことがある。

```shell
| 36    | 0   | 36  | 0   | 0   | 0   | GET    | /image/9999.jpg    | 0.002 | 4.547 | 51.597  | 1.433 | 3.021 | 3.080 | 4.547 | 1.413  | 89928.000   | 89928.000   | 3237408.000  | 89928.000   |
| 35    | 0   | 35  | 0   | 0   | 0   | GET    | /image/9980.jpg    | 0.001 | 5.041 | 43.937  | 1.255 | 3.598 | 4.647 | 5.041 | 1.563  | 95919.000   | 95919.000   | 3357165.000  | 95919.000   |
| 36    | 0   | 36  | 0   | 0   | 0   | GET    | /image/9998.jpg    | 0.001 | 3.050 | 40.994  | 1.139 | 2.988 | 3.049 | 3.050 | 1.173  | 61656.000   | 61656.000   | 2219616.000  | 61656.000   |
| 1     | 0   | 1   | 0   | 0   | 0   | GET    | /posts/8685        | 4.442 | 4.442 | 4.442   | 4.442 | 4.442 | 4.442 | 4.442 | 0.000  | 1472.000    | 1472.000    | 1472.000     | 1472.000    |
| 1     | 0   | 1   | 0   | 0   | 0   | GET    | /posts/8783        | 3.055 | 3.055 | 3.055   | 3.055 | 3.055 | 3.055 | 3.055 | 0.000  | 1357.000    | 1357.000    | 1357.000     | 1357.000    |
```

以降は、alpでの対処方法について説明する。まずは設定ファイル(alp_config.yml)を作成する。

```yaml
---
file: /var/log/nginx/access.log # string
sort: sum                       # max|min|avg|sum|count|uri|method|max-body|min-body|avg-body|sum-body|p1|p50|p99|stddev
output:                         # string(comma separated)
reverse: true                   # boolean
query_string:                   # boolean
query_string_ignore_values:     # boolean
decode_uri:                     # boolean
format:                         # string
limit:                          # 5000
noheaders:                      # boolean
show_footers:                   # boolean
filters:                        # string
pos_file:                       # string
nosave_pos:                     # boolean
percentiles:                    # array
ltsv:
  apptime_label: # apptime
  status_label:  # status code
  size_label:    # size
  method_label:  # method
  uri_label:     # uri
  time_label:    # time
json:
  uri_key:           # string
  method_key:        # string
  time_key:          # string
  response_time_key: # string
  body_bytes_key:    # string
  status_key:        # string
regexp:
  pattern:              # string
  uri_subexp:           # string
  method_subexp:        # string
  time_subexp:          # string
  response_time_subexp: # string
  body_bytes_subexp:    # string
  status_subexp:        # string
pcap:
  server_ips:  # array
  server_port: # number
matching_groups: # array
```

参考: [alpのリポジトリにある設定例](https://github.com/tkuchiki/alp/blob/d91a23dc2d71521c5a9e166faf92f68d082fb85f/example/config.yml)

上記の設定ファイルを用いて、alpを実行する方法は下記の通り

```shell
sudo alp ltsv --config alp_config.yml > "$HOME/log/alp/alp_log_$(date +'%Y%m%d%H%M').txt"
```

設定ファイルで下記のように設定することで、`/image/[ファイル名]`というパスを同一のリクエストとして扱うことができる。

```yaml
matching_groups: # array
  - /image/[a-zA-Z0-9]+ # /image/:file_name
  - /posts/[0-9]+ # /posts/:id
```

実際に上記の設定を用いて解析した結果は下記の通り

```shell
+-------+-----+------+-----+-----+-----+--------+----------------------+-------+-------+----------+-------+-------+-------+-------+--------+-----------+-------------+---------------+------------+
| COUNT | 1XX | 2XX  | 3XX | 4XX | 5XX | METHOD |         URI          |  MIN  |  MAX  |   SUM    |  AVG  |  P90  |  P95  |  P99  | STDDEV | MIN(BODY) |  MAX(BODY)  |   SUM(BODY)   | AVG(BODY)  |
+-------+-----+------+-----+-----+-----+--------+----------------------+-------+-------+----------+-------+-------+-------+-------+--------+-----------+-------------+---------------+------------+
| 1306  | 0   | 1306 | 0   | 0   | 0   | GET    | /image/[a-zA-Z0-9.]+ | 0.002 | 5.948 | 1137.321 | 0.871 | 2.950 | 3.052 | 4.423 | 1.232  | 45425.000 | 1056749.000 | 256521983.000 | 196418.057 |
| 181   | 0   | 166  | 0   | 15  | 0   | GET    | /                    | 1.404 | 9.981 | 551.902  | 3.049 | 5.612 | 6.302 | 9.279 | 1.779  | 4559.000  | 5986.000    | 865361.000    | 4781.000   |
| 153   | 0   | 0    | 153 | 0   | 0   | POST   | /login               | 0.001 | 7.512 | 255.130  | 1.668 | 4.630 | 5.710 | 7.101 | 1.953  | 0.000     | 0.000       | 0.000         | 0.000      |
| 80    | 0   | 80   | 0   | 0   | 0   | GET    | /favicon.ico         | 0.007 | 8.902 | 246.462  | 3.081 | 7.139 | 7.420 | 8.902 | 2.696  | 43.000    | 43.000      | 3440.000      | 43.000     |
| 60    | 0   | 60   | 0   | 0   | 0   | GET    | /posts/[a-zA-Z0-9.]+ | 0.064 | 5.870 | 80.983   | 1.350 | 3.054 | 4.442 | 5.870 | 1.498  | 704.000   | 1591.000    | 70421.000     | 1173.683   |
```

### (参考) ISUCONにおける修正と確認のサイクルの回し方

ISUCONでは、下記のようなサイクルを回すことが重要である。4.や5.の手順は自動化することが望ましい。

1. ベンチマークを実行
2. ログの解析
3. ログの解析結果を元にコードや設定を修正
4. アプリケーションを再起動
5. 既存のログの削除、もしくはログファイルローテーション(リネームと圧縮)をする
6. 1.に戻る

## CPU/メモリ使用率の解析

よく使われるコマンドとしては、`top`や`htop`がある。これらはCPU使用率が高いプロセスを調べることができる。
これらは現在の情報のみを表示するため、過去の情報との比較が難しい。時系列的に情報が知りたい場合は、`sar`や`dstat`を使う。

ISUCONでは、アプリケーションに負荷がかかっている場合と、DBに負荷がかかっている場合がある。どちらがボトルネックになっているかは、こういったツールで簡易的に調べることができる。

(例) `dstat`の場合

```shell
sudo apt update && sudo apt install dstat

# CPU使用率が高いプロセスを表示
dstat -ta --top-cpu
```
